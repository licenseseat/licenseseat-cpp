name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

env:
  BUILD_TYPE: Release

jobs:
  # =============================================================================
  # Generate Single-Header Distribution
  # =============================================================================
  generate-single-header:
    name: Generate Single-Header
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate single-header
        run: python3 scripts/amalgamate.py > licenseseat_single.hpp

      - name: Verify single-header compiles
        run: |
          sudo apt-get update
          sudo apt-get install -y nlohmann-json3-dev
          git clone --depth 1 --branch v0.18.0 https://github.com/yhirose/cpp-httplib.git /tmp/cpp-httplib
          sudo cp /tmp/cpp-httplib/httplib.h /usr/local/include/

          cat > /tmp/test.cpp << 'EOF'
          #define LICENSESEAT_IMPLEMENTATION
          #include "licenseseat_single.hpp"
          int main() { return 0; }
          EOF
          g++ -std=c++17 -I. -I/usr/local/include -c /tmp/test.cpp -o /tmp/test.o

      - name: Upload single-header artifact
        uses: actions/upload-artifact@v4
        with:
          name: single-header
          path: licenseseat_single.hpp

  # =============================================================================
  # Build Linux x64 Static Library
  # =============================================================================
  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libssl-dev \
            nlohmann-json3-dev \
            cmake \
            ninja-build

      - name: Install cpp-httplib
        run: |
          git clone --depth 1 --branch v0.18.0 https://github.com/yhirose/cpp-httplib.git /tmp/cpp-httplib
          sudo mkdir -p /usr/local/include
          sudo cp /tmp/cpp-httplib/httplib.h /usr/local/include/
          sudo mkdir -p /usr/local/lib/cmake/httplib
          cat << 'EOF' | sudo tee /usr/local/lib/cmake/httplib/httplibConfig.cmake
          add_library(httplib::httplib INTERFACE IMPORTED)
          set_target_properties(httplib::httplib PROPERTIES
            INTERFACE_INCLUDE_DIRECTORIES "/usr/local/include"
          )
          EOF

      - name: Configure
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DLICENSESEAT_BUILD_TESTS=OFF \
            -DLICENSESEAT_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - name: Package
        run: |
          mkdir -p package/lib package/include
          cp build/liblicenseseat.a package/lib/
          cp -r include/licenseseat package/include/
          cp LICENSE package/ 2>/dev/null || echo "MIT License" > package/LICENSE
          cp README.md package/ 2>/dev/null || true
          cd package && tar -czvf ../licenseseat-linux-x64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: licenseseat-linux-x64.tar.gz

  # =============================================================================
  # Build macOS Intel Static Library
  # =============================================================================
  build-macos-intel:
    name: Build macOS Intel
    runs-on: macos-15-intel

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          brew install \
            openssl@3 \
            nlohmann-json \
            cpp-httplib \
            ninja

      - name: Configure
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DLICENSESEAT_BUILD_TESTS=OFF \
            -DLICENSESEAT_BUILD_EXAMPLES=OFF \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build
        run: cmake --build build

      - name: Package
        run: |
          mkdir -p package/lib package/include
          cp build/liblicenseseat.a package/lib/
          cp -r include/licenseseat package/include/
          cp LICENSE package/ 2>/dev/null || echo "MIT License" > package/LICENSE
          cp README.md package/ 2>/dev/null || true
          cd package && tar -czvf ../licenseseat-macos-intel.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel
          path: licenseseat-macos-intel.tar.gz

  # =============================================================================
  # Build macOS ARM64 Static Library
  # =============================================================================
  build-macos-arm:
    name: Build macOS ARM64
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          brew install \
            openssl@3 \
            nlohmann-json \
            cpp-httplib \
            ninja

      - name: Configure
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DLICENSESEAT_BUILD_TESTS=OFF \
            -DLICENSESEAT_BUILD_EXAMPLES=OFF \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build
        run: cmake --build build

      - name: Package
        run: |
          mkdir -p package/lib package/include
          cp build/liblicenseseat.a package/lib/
          cp -r include/licenseseat package/include/
          cp LICENSE package/ 2>/dev/null || echo "MIT License" > package/LICENSE
          cp README.md package/ 2>/dev/null || true
          cd package && tar -czvf ../licenseseat-macos-arm64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: licenseseat-macos-arm64.tar.gz

  # =============================================================================
  # Build Windows x64 Static Library
  # =============================================================================
  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-2022

    env:
      # Disable vcpkg binary caching entirely (x-gha was removed in June 2025)
      VCPKG_BINARY_SOURCES: "clear"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "c82f74667287d3dc386bce81e44964370c91a289"

      - name: Cache vcpkg installed packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-installed-release-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-installed-release-${{ runner.os }}-
            vcpkg-installed-${{ runner.os }}-

      - name: Configure
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DLICENSESEAT_BUILD_TESTS=OFF `
            -DLICENSESEAT_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Package
        shell: bash
        run: |
          mkdir -p package/lib package/include
          cp build/Release/licenseseat.lib package/lib/
          cp -r include/licenseseat package/include/
          cp LICENSE package/ 2>/dev/null || echo "MIT License" > package/LICENSE
          cp README.md package/ 2>/dev/null || true
          cd package && 7z a ../licenseseat-windows-x64.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: licenseseat-windows-x64.zip

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-24.04
    needs:
      - generate-single-header
      - build-linux-x64
      - build-macos-intel
      - build-macos-arm
      - build-windows-x64
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          cp artifacts/single-header/licenseseat_single.hpp release/
          cp artifacts/linux-x64/licenseseat-linux-x64.tar.gz release/
          cp artifacts/macos-intel/licenseseat-macos-intel.tar.gz release/
          cp artifacts/macos-arm64/licenseseat-macos-arm64.tar.gz release/
          cp artifacts/windows-x64/licenseseat-windows-x64.zip release/
          ls -la release/

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: LicenseSeat C++ SDK ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            release/licenseseat_single.hpp
            release/licenseseat-linux-x64.tar.gz
            release/licenseseat-macos-intel.tar.gz
            release/licenseseat-macos-arm64.tar.gz
            release/licenseseat-windows-x64.zip
          body: |
            ## Installation

            ### Single-Header (Recommended for plugins/games)
            Download `licenseseat_single.hpp` - no external dependencies except nlohmann/json and cpp-httplib.

            ```cpp
            // In ONE .cpp file:
            #define LICENSESEAT_IMPLEMENTATION
            #include "licenseseat_single.hpp"

            // In all other files:
            #include "licenseseat_single.hpp"
            ```

            ### Prebuilt Static Libraries
            Download the appropriate archive for your platform:
            - **Linux x64**: `licenseseat-linux-x64.tar.gz`
            - **macOS Intel**: `licenseseat-macos-intel.tar.gz`
            - **macOS ARM64**: `licenseseat-macos-arm64.tar.gz`
            - **Windows x64**: `licenseseat-windows-x64.zip`

            Each archive contains:
            - `lib/` - Static library (`liblicenseseat.a` or `licenseseat.lib`)
            - `include/` - Header files

            Link with OpenSSL (`-lssl -lcrypto`) when using prebuilt libraries.

            ## Requirements
            - C++17 compiler
            - nlohmann/json (for JSON parsing)
            - cpp-httplib (for HTTP/HTTPS requests)
            - OpenSSL (for prebuilt libraries; not needed for single-header)
